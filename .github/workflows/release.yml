name: Release

on:
  push:
    branches: [main]

jobs:
  # Run semantic-release (creates tag, GitHub release, and CHANGELOG automatically)
  semantic-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Required for semantic-release
          token: ${{ secrets.GITHUB_TOKEN }} # Required for pushing tags
      - uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest
      - run: bun install
      - name: Run semantic-release
        id: semantic-release
        run: bun run release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      # After semantic-release runs, check if release was created
      # If not, create it manually (fallback in case @semantic-release/github fails)
      - name: Ensure release exists for tag
        run: |
          # Fetch tags that semantic-release just pushed
          git fetch --tags --force
          
          # Get the latest tag (should be the one just created by semantic-release)
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          if [ -z "$LATEST_TAG" ]; then
            echo "‚ö†Ô∏è  No tags found - semantic-release may not have created a release"
            exit 0
          fi
          
          echo "üìã Latest tag: $LATEST_TAG"
          
          # Check if release exists
          if gh release view "$LATEST_TAG" &>/dev/null; then
            echo "‚úÖ Release already exists for $LATEST_TAG"
          else
            echo "‚ö†Ô∏è  Release not found for $LATEST_TAG, creating it..."
            
            # Extract release notes from CHANGELOG
            VERSION_NUM="${LATEST_TAG#v}"  # Remove 'v' prefix
            
            if [ -f services/app/CHANGELOG.md ]; then
              # Extract the section for this version from CHANGELOG.md
              NOTES=$(awk "/^## \[${VERSION_NUM}\]/,/^## \[/" services/app/CHANGELOG.md | sed '$d' || echo "")
              
              if [ -n "$NOTES" ]; then
                echo "üìù Using CHANGELOG notes for release"
                gh release create "$LATEST_TAG" \
                  --title "$LATEST_TAG" \
                  --notes "$NOTES" \
                  --target main
              else
                echo "üìù Generating release notes automatically"
                gh release create "$LATEST_TAG" \
                  --title "$LATEST_TAG" \
                  --generate-notes \
                  --target main
              fi
            else
              echo "üìù Generating release notes automatically (no CHANGELOG found)"
              gh release create "$LATEST_TAG" \
                --title "$LATEST_TAG" \
                --generate-notes \
                --target main
            fi
            
            echo "‚úÖ Release created for $LATEST_TAG"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
