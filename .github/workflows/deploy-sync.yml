name: Deploy Sync Service

# Temporarily disabled - only deploying me service
# on:
#   workflow_run:
#     workflows: ['Release']
#     types:
#       - completed
#     branches:
#       - main
#   workflow_dispatch: # Allow manual trigger
on:
  workflow_dispatch: # Only allow manual trigger for now

jobs:
  deploy-sync:
    name: Deploy Sync Service
    runs-on: ubuntu-latest
    # Temporarily disabled - only deploying me service
    # if: (github.event_name == 'workflow_dispatch') || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
    if: github.event_name == 'workflow_dispatch' # Only manual trigger for now
    environment: PRODUCTION
    # FLY_API_TOKEN is an organization-wide secret (accessible regardless of environment)
    # All other secrets are from the PRODUCTION environment
    env:
      FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
    steps:
      - uses: actions/checkout@v4

      - uses: superfly/flyctl-actions/setup-flyctl@master

      - name: Create Fly.io app if it doesn't exist
        run: |
          # Check if app exists, create if it doesn't
          if ! flyctl apps list | grep -q "hominio-sync"; then
            echo "üì¶ Creating Fly.io app: hominio-sync..."
            flyctl apps create hominio-sync --org personal || {
              echo "‚ö†Ô∏è  Failed to create app. It may already exist or you need to specify a different org."
              echo "   Continuing with deployment - app may need to be created manually."
            }
            
            # Set primary region
            flyctl regions set fra --app hominio-sync || true
          else
            echo "‚úÖ App hominio-sync already exists"
          fi

          # Always ensure IP addresses are allocated (idempotent - safe to run multiple times)
          echo "üåê Ensuring IP addresses are allocated..."
          # Check if IPv4 exists, allocate if missing
          if ! flyctl ips list --app hominio-sync | grep -q "v4"; then
            echo "   Allocating IPv4 address..."
            flyctl ips allocate-v4 --app hominio-sync --shared || true
          else
            echo "   IPv4 address already allocated"
          fi

          # Check if IPv6 exists, allocate if missing
          if ! flyctl ips list --app hominio-sync | grep -q "v6"; then
            echo "   Allocating IPv6 address..."
            flyctl ips allocate-v6 --app hominio-sync || true
          else
            echo "   IPv6 address already allocated"
          fi

      - name: Configure custom domain (sync.hominio.me)
        run: |
          echo "üåê Configuring custom domain: sync.hominio.me"
          # Check if certificate already exists
          if flyctl certs list --app hominio-sync 2>/dev/null | grep -q "sync.hominio.me"; then
            echo "‚úÖ Certificate for sync.hominio.me already exists"
            flyctl certs list --app hominio-sync
          else
            echo "üìù Creating certificate for sync.hominio.me..."
            flyctl certs create sync.hominio.me --app hominio-sync || {
              echo "‚ö†Ô∏è  Failed to create certificate (may already exist)"
              flyctl certs list --app hominio-sync || true
            }
          fi

          echo ""
          echo "üìã DNS Configuration Required:"
          echo "   Add a CNAME record in your DNS provider:"
          echo "   Type: CNAME"
          echo "   Name: sync"
          echo "   Value: hominio-sync.fly.dev"
          echo "   TTL: 300 (or your preferred TTL)"
          echo ""
          echo "   After DNS propagates, Fly.io will automatically provision Let's Encrypt certificate."

      - name: Set Fly.io secrets for sync service
        run: |
          # Set all required environment variables from GitHub secrets
          # Map ZERO_POSTGRES_SECRET to ZERO_UPSTREAM_DB (Zero expects ZERO_UPSTREAM_DB)
          # Using standardized naming convention (ZERO_POSTGRES_SECRET, etc.)
          # Production URLs point to api.hominio.me API service
          # Retry logic for machine lease issues (Fly.io sometimes has temporary lease conflicts)
          MAX_RETRIES=5
          RETRY_DELAY=15
          RETRY_COUNT=0
          SUCCESS=false

          while [ $RETRY_COUNT -lt $MAX_RETRIES ] && [ "$SUCCESS" != "true" ]; do
            RETRY_COUNT=$((RETRY_COUNT + 1))
            
            echo "üìù Setting secrets (attempt $RETRY_COUNT/$MAX_RETRIES)..."
            
            # Capture both stdout and stderr
            OUTPUT=$(flyctl secrets set \
              ZERO_UPSTREAM_DB="${{ secrets.ZERO_POSTGRES_SECRET }}" \
              ZERO_CHANGE_DB="${{ secrets.ZERO_POSTGRES_SECRET }}" \
              ZERO_POSTGRES_SECRET="${{ secrets.ZERO_POSTGRES_SECRET }}" \
              ZERO_AUTH_SECRET="${{ secrets.AUTH_SECRET }}" \
              ZERO_ADMIN_AUTH="${{ secrets.AUTH_SECRET }}" \
              ZERO_GET_QUERIES_URL="https://api.hominio.me/api/v0/zero/get-queries" \
              ZERO_PUSH_URL="https://api.hominio.me/api/v0/zero/push" \
              ZERO_GET_QUERIES_FORWARD_COOKIES="true" \
              ZERO_MUTATE_FORWARD_COOKIES="true" \
              ZERO_DB_CONNECT_TIMEOUT="10" \
              NODE_ENV="production" \
              --app hominio-sync 2>&1)
            
            EXIT_CODE=$?
            echo "$OUTPUT"
            
            # Check for lease conflict in output
            if echo "$OUTPUT" | grep -qi "lease currently held"; then
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "‚ö†Ô∏è  Machine lease conflict detected. Waiting ${RETRY_DELAY}s before retry... (attempt $RETRY_COUNT/$MAX_RETRIES)"
                sleep $RETRY_DELAY
              else
                echo "‚ùå Failed to set secrets after $MAX_RETRIES attempts due to lease conflicts"
                echo "   This usually resolves itself - try running the workflow again in a few minutes"
                exit 1
              fi
            elif [ $EXIT_CODE -eq 0 ]; then
              SUCCESS=true
              echo "‚úÖ Secrets set successfully!"
            else
              # Other error - don't retry
              echo "‚ùå Failed to set secrets (exit code: $EXIT_CODE)"
              exit 1
            fi
          done

          # Explicitly unset deprecated flags if they exist (cleanup)
          echo "üßπ Cleaning up deprecated environment variables..."
          flyctl secrets unset ZERO_CHANGE_STREAMER_PROTOCOL ZERO_TARGET_CLIENT_ROW_COUNT --app hominio-sync 2>/dev/null || echo "   (No deprecated flags found - this is expected)"

          echo "‚úÖ Sync service secrets set. Verifying..."
          flyctl secrets list --app hominio-sync

      - name: Deploy sync service
        run: |
          cd services/sync
          flyctl deploy --remote-only --app hominio-sync

      - name: Ensure exactly 1 machine (no auto-scaling)
        run: |
          # Explicitly set scale count to 1 to prevent auto-scaling
          # This ensures only one machine runs, preventing replication slot conflicts
          flyctl scale count 1 --yes --app hominio-sync

      - name: Wait for health check to pass
        run: |
          echo "‚è≥ Waiting for health check to pass (this may take up to 5 minutes for Zero initialization)..."
          MAX_ATTEMPTS=120  # 120 attempts * 5 seconds = 10 minutes max wait
          for i in $(seq 1 $MAX_ATTEMPTS); do
            # Check machine health status via flyctl
            HEALTH_STATUS=$(flyctl status --app hominio-sync --json 2>/dev/null | jq -r '.Machines[0].HealthChecks[0].Status // .Machines[0].Checks[0].Status // "unknown"' 2>/dev/null || echo "unknown")
            
            # Also check if we can connect to the service directly
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 https://sync.hominio.me/ 2>/dev/null || echo "000")
            
            # Show progress every 10 attempts
            if [ $((i % 10)) -eq 0 ] || [ "$HEALTH_STATUS" = "pass" ] || [ "$HEALTH_STATUS" = "ok" ]; then
              echo "   Health check status: $HEALTH_STATUS, HTTP response: $HTTP_CODE (attempt $i/$MAX_ATTEMPTS)"
            fi
            
            # Success conditions: health check passes OR service responds (not 502/503/000)
            if [ "$HEALTH_STATUS" = "pass" ] || [ "$HEALTH_STATUS" = "ok" ]; then
              echo "‚úÖ Health check passed!"
              break
            fi
            
            # Also accept if service is responding (even if health check hasn't updated yet)
            if [ "$HTTP_CODE" != "000" ] && [ "$HTTP_CODE" != "502" ] && [ "$HTTP_CODE" != "503" ]; then
              echo "‚úÖ Service is responding (HTTP $HTTP_CODE), health check may still be initializing..."
              # Wait a bit more to ensure health check catches up
              sleep 10
              break
            fi
            
            # Timeout after max attempts
            if [ $i -eq $MAX_ATTEMPTS ]; then
              echo "‚ùå Timeout: Health check did not pass within $MAX_ATTEMPTS attempts (10 minutes)"
              echo "Checking machine status and recent logs..."
              flyctl status --app hominio-sync
              echo ""
              echo "üìã Recent logs:"
              flyctl logs --app hominio-sync --limit 100
              exit 1
            fi
            
            sleep 5  # Check every 5 seconds
          done
          echo "‚úÖ Machine is ready for migrations"

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: |
          bun install

      - name: Run database migration
        run: |
          echo "üîÑ Running Zero database migration..."
          cd services/sync
          bun run scripts/zero-migrate.js
        env:
          ZERO_POSTGRES_SECRET: ${{ secrets.ZERO_POSTGRES_SECRET }}
          ADMIN: ${{ secrets.ADMIN }}

      - name: Deploy Zero schema permissions
        run: |
          echo "üîÑ Deploying Zero schema permissions..."
          cd services/sync
          bunx zero-deploy-permissions -p ../../libs/hominio-zero/src/schema.ts
        env:
          ZERO_UPSTREAM_DB: ${{ secrets.ZERO_POSTGRES_SECRET }}

      - name: Check deployment status
        run: |
          flyctl status --app hominio-sync
          echo "üìã Recent logs:"
          flyctl logs --app hominio-sync --no-tail | tail -50

      - name: Verify SSL certificate status
        run: |
          echo "üîí Checking SSL certificate status for sync.hominio.me..."
          flyctl certs check sync.hominio.me --app hominio-sync || {
            echo "‚ö†Ô∏è  Certificate not yet issued. This is normal if DNS hasn't propagated yet."
            echo "   Certificate will be automatically provisioned once DNS CNAME record is configured."
          }
