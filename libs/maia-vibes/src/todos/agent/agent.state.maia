{
  "$schema": "@schema/state",
  "$id": "@state/agent",
  "initial": "idle",
  "states": {
    "idle": {
      "on": {
        "CREATE_BUTTON": {
          "target": "creating",
          "guard": {
            "$and": [
              { "$ne": ["$$text", null] },
              { "$ne": [{ "$trim": "$$text" }, ""] }
            ]
          }
        },
        "TOGGLE_BUTTON": {
          "target": "toggling"
        },
        "DELETE_BUTTON": {
          "target": "deleting"
        },
        "SWITCH_VIEW": {
          "target": "idle"
        },
        "UPDATE_INPUT": {
          "target": "idle"
        }
      }
    },
    "creating": {
      "entry": {
        "tool": "@db",
        "payload": { 
          "op": "create",
          "schema": "@schema/data/todos",
          "data": { "text": "$$text", "done": false }
        }
      },
      "on": {
        "UPDATE_INPUT": {
          "target": "idle"
        },
        "CREATE_BUTTON": {
          "target": "creating"
        },
        "TOGGLE_BUTTON": {
          "target": "toggling"
        },
        "DELETE_BUTTON": {
          "target": "deleting"
        },
        "SUCCESS": {
          "target": "idle",
          "actions": [
            {
              "tool": "@core/publishMessage",
              "payload": {
                "type": "TODO_CREATED",
                "payload": {
                  "id": "$$result.id",
                  "text": "$$result.text",
                  "done": false
                },
                "target": "@actor/composite"
              }
            },
            {
              "tool": "@core/publishMessage",
              "payload": {
                "type": "TODO_CREATED",
                "payload": {
                  "id": "$$result.id",
                  "text": "$$result.text",
                  "done": false
                },
                "target": "@actor/kanban"
              }
            },
            {
              "tool": "@core/publishMessage",
              "payload": {
                "type": "INPUT_CLEARED",
                "target": "@actor/composite"
              }
            }
          ]
        },
        "ERROR": "error"
      }
    },
    "toggling": {
      "entry": {
        "tool": "@db",
        "payload": { 
          "op": "update",
          "id": "$$id",
          "data": {
            "done": {
              "$not": "$$done"
            }
          }
        }
      },
      "on": {
        "TOGGLE_BUTTON": {
          "target": "toggling"
        },
        "DELETE_BUTTON": {
          "target": "deleting"
        },
        "UPDATE_INPUT": {
          "target": "idle"
        },
        "CREATE_BUTTON": {
          "target": "creating"
        },
        "SWITCH_VIEW": {
          "target": "idle"
        },
        "SUCCESS": {
          "target": "idle",
          "actions": [
            {
              "tool": "@core/publishMessage",
              "payload": {
                "type": "TODO_COMPLETED",
                "payload": { "id": "$$id" },
                "target": "@actor/composite"
              }
            },
            {
              "tool": "@core/publishMessage",
              "payload": {
                "type": "TODO_COMPLETED",
                "payload": { "id": "$$id" },
                "target": "@actor/kanban"
              }
            }
          ]
        },
        "ERROR": "error"
      }
    },
    "deleting": {
      "entry": [
        {
          "updateContext": { "deletingId": "$$id" }
        },
        {
          "tool": "@db",
          "payload": { 
            "op": "delete",
            "id": "$$id"
          }
        }
      ],
      "on": {
        "DELETE_BUTTON": {
          "target": "deleting"
        },
        "UPDATE_INPUT": {
          "target": "idle"
        },
        "CREATE_BUTTON": {
          "target": "creating"
        },
        "SWITCH_VIEW": {
          "target": "idle"
        },
        "TOGGLE_BUTTON": {
          "target": "toggling"
        },
        "SUCCESS": {
          "target": "idle",
          "actions": [
            {
              "tool": "@core/publishMessage",
              "payload": {
                "type": "TODO_DELETED",
                "payload": { "id": "$context.deletingId" },
                "target": "@actor/composite"
              }
            },
            {
              "tool": "@core/publishMessage",
              "payload": {
                "type": "TODO_DELETED",
                "payload": { "id": "$context.deletingId" },
                "target": "@actor/kanban"
              }
            },
            {
              "updateContext": { "deletingId": null }
            }
          ]
        },
        "ERROR": {
          "target": "error",
          "actions": [
            {
              "updateContext": { "deletingId": null }
            }
          ]
        }
      }
    },
    "error": {
      "entry": {
        "updateContext": { "error": "$$error" }
      },
      "on": {
        "TOGGLE_BUTTON": {
          "target": "toggling"
        },
        "DELETE_BUTTON": {
          "target": "deleting"
        },
        "RETRY": {
          "target": "idle",
          "actions": [
            {
              "updateContext": { "error": null }
            }
          ]
        },
        "DISMISS": {
          "target": "idle",
          "actions": [
            {
              "updateContext": { "error": null }
            }
          ]
        }
      }
    }
  }
}
