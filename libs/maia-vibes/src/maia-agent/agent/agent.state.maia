{
  "$schema": "@schema/state",
  "$id": "@maia/state/agent",
  "initial": "idle",
  "states": {
    "idle": {
      "on": {
        "RENDER_COMPLETE": {
          "target": "initializing",
          "guard": {
            "$eq": ["$honchoSessionId", null]
          },
          "actions": [
            {
              "updateContext": {
                "hasConversations": {
                  "$gt": [{ "$length": "$conversations" }, 0]
                }
              }
            }
          ]
        },
        "SEND_MESSAGE": {
          "target": "gettingContext",
          "guard": {
            "$and": [
              { "$ne": ["$$inputText", null] },
              { "$ne": [{ "$trim": "$$inputText" }, ""] },
              { "$ne": ["$honchoSessionId", null] }
            ]
          }
        },
        "UPDATE_INPUT": {
          "target": "idle",
          "actions": [
            {
              "updateContext": { "inputText": "$$inputText" }
            }
          ]
        }
      }
    },
    "initializing": {
      "entry": {
        "tool": "@memory",
        "payload": {
          "op": "createSession",
          "workspaceId": "$workspaceId",
          "peerId": "maia",
          "sessionId": {
            "$concat": ["session-maia-", { "$toString": { "$now": [] } }]
          }
        }
      },
      "on": {
        "SUCCESS": {
          "target": "idle",
          "actions": [
            {
              "updateContext": { "honchoSessionId": "$$result.sessionId" }
            }
          ]
        },
        "ERROR": "error"
      }
    },
    "gettingContext": {
      "entry": [
        {
          "updateContext": { 
            "isLoading": true,
            "hasError": false
          }
        },
        {
          "tool": "@memory",
          "payload": {
            "op": "getContext",
            "workspaceId": "$workspaceId",
            "peerId": "maia",
            "sessionId": "$honchoSessionId",
            "query": "What should I know about this user and our previous conversations? Provide relevant context."
          }
        }
      ],
      "on": {
        "SUCCESS": {
          "target": "chatting",
          "actions": [
            {
              "updateContext": { "context": "$$result.context" }
            }
          ]
        },
        "ERROR": "error"
      }
    },
    "chatting": {
      "entry": {
        "tool": "@llm/chat",
        "payload": {
          "messages": {
            "$concat": [
              [
                {
                  "role": "system",
                  "content": "You are Maia, a CTO-level AI assistant that understands the entire MaiaOS codebase, architecture, and all packages. You learn alongside coding sessions and remember past conversations. Be helpful, technical, and concise."
                }
              ],
              {
                "$if": {
                  "condition": { "$ne": ["$context", null] },
                  "then": [
                    {
                      "role": "system",
                      "content": {
                        "$concat": ["Context from memory: ", "$context"]
                      }
                    }
                  ],
                  "else": []
                }
              },
              {
                "$map": {
                  "array": "$conversations",
                  "as": "msg",
                  "return": {
                    "role": "$$msg.role",
                    "content": "$$msg.content"
                  }
                }
              },
              [
                {
                  "role": "user",
                  "content": "$$inputText"
                }
              ]
            ]
          }
        }
      },
      "on": {
        "SUCCESS": {
          "target": "storingMessage",
          "actions": [
            {
              "updateContext": { "assistantResponse": "$$result.content" }
            }
          ]
        },
        "ERROR": "error"
      }
    },
    "storingMessage": {
      "entry": {
        "tool": "@memory",
        "payload": {
          "op": "addMessage",
          "workspaceId": "$workspaceId",
          "sessionId": "$honchoSessionId",
          "peerId": "samuel",
          "content": "$$inputText"
        }
      },
      "on": {
        "SUCCESS": {
          "target": "storingAssistantMessage"
        },
        "ERROR": "error"
      }
    },
    "storingAssistantMessage": {
      "entry": {
        "tool": "@memory",
        "payload": {
          "op": "addMessage",
          "workspaceId": "$workspaceId",
          "sessionId": "$honchoSessionId",
          "peerId": "maia",
          "content": "$assistantResponse"
        }
      },
      "on": {
        "SUCCESS": {
          "target": "idle",
          "actions": [
            {
              "updateContext": {
                "conversations": {
                  "$concat": [
                    "$conversations",
                    [
                      {
                        "role": "user",
                        "content": "$$inputText"
                      },
                      {
                        "role": "assistant",
                        "content": "$assistantResponse"
                      }
                    ]
                  ]
                }
              }
            },
            {
              "updateContext": {
                "hasConversations": {
                  "$gt": [
                    {
                      "$length": {
                        "$concat": [
                          "$conversations",
                          [
                            {
                              "role": "user",
                              "content": "$$inputText"
                            },
                            {
                              "role": "assistant",
                              "content": "$assistantResponse"
                            }
                          ]
                        ]
                      }
                    },
                    0
                  ]
                }
              }
            },
            {
              "updateContext": { "inputText": "" }
            },
            {
              "updateContext": { "isLoading": false }
            },
            {
              "updateContext": { "context": null }
            },
            {
              "updateContext": { "assistantResponse": null }
            },
            {
              "updateContext": { "hasError": false }
            }
          ]
        },
        "ERROR": "error"
      }
    },
    "error": {
      "entry": {
        "updateContext": { 
          "error": "$$error", 
          "isLoading": false,
          "hasError": true
        }
      },
      "on": {
        "RETRY": {
          "target": "idle",
          "actions": [
            {
              "updateContext": { 
                "error": null,
                "hasError": false
              }
            }
          ]
        },
        "DISMISS": {
          "target": "idle",
          "actions": [
            {
              "updateContext": { 
                "error": null,
                "hasError": false
              }
            }
          ]
        }
      }
    }
  }
}
