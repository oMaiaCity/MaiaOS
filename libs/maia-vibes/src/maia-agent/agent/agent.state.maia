{
  "$schema": "@schema/state",
  "$id": "@maia/state/agent",
  "initial": "idle",
  "states": {
    "idle": {
      "on": {
        "RENDER_COMPLETE": {
          "target": "idle",
          "actions": [
            {
              "updateContext": {
                "hasConversations": {
                  "$gt": [{ "$length": "$conversations" }, 0]
                }
              }
            }
          ]
        },
        "SEND_MESSAGE": {
          "target": "chatting",
          "guard": {
            "$and": [
              { "$ne": ["$$inputText", null] },
              { "$ne": [{ "$trim": "$$inputText" }, ""] }
            ]
          }
        },
        "UPDATE_INPUT": {
          "target": "idle",
          "actions": [
            {
              "updateContext": { "inputText": "$$inputText" }
            }
          ]
        }
      }
    },
    "chatting": {
      "entry": [
        {
          "updateContext": { 
            "isLoading": true,
            "hasError": false,
            "inputText": "$$inputText"
          }
        },
        {
          "tool": "@db",
          "payload": {
            "op": "create",
            "schema": "@schema/data/chat",
            "data": {
              "role": "user",
              "content": "$$inputText"
            }
          }
        }
      ],
      "on": {
        "SUCCESS": {
          "target": "calling_llm"
        },
        "ERROR": {
          "target": "error",
          "actions": [
            {
              "updateContext": {
                "isLoading": false
              }
            }
          ]
        }
      }
    },
    "calling_llm": {
      "entry": {
        "tool": "@private-llm/chat",
        "payload": {
          "messages": {
            "$concat": [
              [
                {
                  "role": "system",
                  "content": "You are Maia, a CTO-level AI assistant that understands the entire MaiaOS codebase, architecture, and all packages. You learn alongside coding sessions. Be helpful, technical, and concise."
                }
              ],
              {
                "$map": {
                  "array": "$conversations",
                  "as": "msg",
                  "return": {
                    "role": "$$msg.role",
                    "content": "$$msg.content"
                  }
                }
              },
              [
                {
                  "role": "user",
                  "content": "$inputText"
                }
              ]
            ]
          }
        }
      },
      "on": {
        "SUCCESS": {
          "target": "saving_response"
        },
        "ERROR": {
          "target": "error",
          "actions": [
            {
              "updateContext": {
                "isLoading": false
              }
            }
          ]
        }
      }
    },
    "saving_response": {
      "entry": [
        {
          "tool": "@db",
          "payload": {
            "op": "create",
            "schema": "@schema/data/chat",
            "data": {
              "role": "assistant",
              "content": "$$result.content"
            }
          }
        }
      ],
      "on": {
        "SUCCESS": {
          "target": "idle",
          "actions": [
            {
              "updateContext": { 
                "inputText": "",
                "assistantResponse": null,
                "isLoading": false,
                "hasError": false
              }
            },
            {
              "updateContext": {
                "hasConversations": {
                  "$gt": [{ "$length": "$conversations" }, 0]
                }
              }
            }
          ]
        },
        "ERROR": {
          "target": "error",
          "actions": [
            {
              "updateContext": {
                "isLoading": false
              }
            }
          ]
        }
      }
    },
    "error": {
      "entry": {
        "updateContext": { 
          "error": "$$error",
          "isLoading": false,
          "hasError": true
        }
      },
      "on": {
        "SEND_MESSAGE": {
          "target": "chatting",
          "guard": {
            "$and": [
              { "$ne": ["$$inputText", null] },
              { "$ne": [{ "$trim": "$$inputText" }, ""] }
            ]
          },
          "actions": [
            {
              "updateContext": { 
                "error": null,
                "hasError": false
              }
            }
          ]
        },
        "RETRY": {
          "target": "idle",
          "actions": [
            {
              "updateContext": { 
                "error": null,
                "hasError": false
              }
            }
          ]
        },
        "DISMISS": {
          "target": "idle",
          "actions": [
            {
              "updateContext": { 
                "error": null,
                "hasError": false
              }
            }
          ]
        }
      }
    }
  }
}
