{
	"$schema": "°Maia/schema/state",
	"$id": "°Maia/chat/state/messages",
	"initial": "idle",
	"states": {
		"idle": {
			"on": {
				"SEND_MESSAGE": {
					"target": "chatting"
				}
			}
		},
		"chatting": {
			"entry": [
				{
					"updateContext": {
						"isLoading": true,
						"hasError": false,
						"error": null
					}
				},
				{
					"tool": "@core/publishMessage",
					"payload": {
						"type": "STATUS_UPDATE",
						"payload": {
							"isLoading": true,
							"hasError": false,
							"error": null
						},
						"target": "°Maia/chat/actor/vibe"
					}
				},
				{
					"tool": "@db",
					"payload": {
						"op": "create",
						"schema": "°Maia/schema/data/chat",
						"data": {
							"role": "user",
							"content": "$$inputText",
							"displayName": "me"
						}
					}
				}
			],
			"on": {
				"SUCCESS": {
					"target": "calling_llm"
				},
				"ERROR": {
					"target": "error",
					"actions": [
						{
							"updateContext": {
								"isLoading": false
							}
						},
						{
							"tool": "@core/publishMessage",
							"payload": {
								"type": "STATUS_UPDATE",
								"payload": {
									"isLoading": false,
									"hasError": true,
									"error": "$$errors.0.message"
								},
								"target": "°Maia/chat/actor/vibe"
							}
						}
					]
				}
			}
		},
		"calling_llm": {
			"entry": {
				"tool": "@ai/chat",
				"payload": {
					"model": "qwen/qwen3-30b-a3b-instruct-2507",
					"temperature": 1,
					"context": {
						"$concat": [
							[
								{
									"role": "system",
									"content": "You are Maia, a CTO-level AI assistant that understands the entire MaiaOS codebase, architecture, and all packages. You learn alongside coding sessions. Be helpful, technical, and concise. Never use emoticons in your responses."
								}
							],
							{
								"$map": {
									"array": "$conversations",
									"as": "msg",
									"return": {
										"role": "$$msg.role",
										"content": "$$msg.content"
									}
								}
							}
						]
					}
				}
			},
			"on": {
				"SUCCESS": {
					"target": "saving_response"
				},
				"ERROR": {
					"target": "error",
					"actions": [
						{
							"updateContext": {
								"isLoading": false
							}
						},
						{
							"tool": "@core/publishMessage",
							"payload": {
								"type": "STATUS_UPDATE",
								"payload": {
									"isLoading": false,
									"hasError": true,
									"error": "$$errors.0.message"
								},
								"target": "°Maia/chat/actor/vibe"
							}
						}
					]
				}
			}
		},
		"saving_response": {
			"entry": [
				{
					"tool": "@db",
					"payload": {
						"op": "create",
						"schema": "°Maia/schema/data/chat",
						"data": {
							"role": "assistant",
							"content": "$$result.content",
							"displayName": "Maia"
						}
					}
				}
			],
			"on": {
				"SUCCESS": {
					"target": "idle",
					"actions": [
						{
							"updateContext": {
								"isLoading": false,
								"hasError": false,
								"error": null
							}
						},
						{
							"tool": "@core/publishMessage",
							"payload": {
								"type": "STATUS_UPDATE",
								"payload": {
									"isLoading": false,
									"hasError": false,
									"error": null
								},
								"target": "°Maia/chat/actor/vibe"
							}
						}
					]
				},
				"ERROR": {
					"target": "error",
					"actions": [
						{
							"updateContext": {
								"isLoading": false
							}
						},
						{
							"tool": "@core/publishMessage",
							"payload": {
								"type": "STATUS_UPDATE",
								"payload": {
									"isLoading": false,
									"hasError": true,
									"error": "$$errors.0.message"
								},
								"target": "°Maia/chat/actor/vibe"
							}
						}
					]
				}
			}
		},
		"error": {
			"entry": [
				{
					"updateContext": {
						"error": "$$errors.0.message",
						"isLoading": false,
						"hasError": true
					}
				},
				{
					"tool": "@core/publishMessage",
					"payload": {
						"type": "STATUS_UPDATE",
						"payload": {
							"isLoading": false,
							"hasError": true,
							"error": "$$errors.0.message"
						},
						"target": "°Maia/chat/actor/vibe"
					}
				}
			],
			"on": {
				"SEND_MESSAGE": {
					"target": "chatting",
					"actions": [
						{
							"updateContext": {
								"error": null,
								"hasError": false
							}
						}
					]
				},
				"RETRY": {
					"target": "idle",
					"actions": [
						{
							"updateContext": {
								"error": null,
								"hasError": false
							}
						}
					]
				},
				"DISMISS": {
					"target": "idle",
					"actions": [
						{
							"updateContext": {
								"error": null,
								"hasError": false
							}
						}
					]
				}
			}
		}
	}
}
