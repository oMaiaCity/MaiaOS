{
	"$schema": "@maia/schema/state",
	"$id": "@maia/chat/state/vibe",
	"initial": "idle",
	"states": {
		"idle": {
			"entry": [
				{
					"updateContext": {
						"isLoading": false
					}
				},
				{
					"tool": "@core/computeMessageNames",
					"payload": {
						"conversations": "$conversations"
					},
					"onSuccess": {
						"updateContext": {
							"messageNames": "$$result"
						}
					}
				}
			],
			"on": {
				"RENDER_COMPLETE": {
					"target": "idle",
					"actions": [
						{
							"updateContext": {
								"hasConversations": {
									"$gt": [
										{
											"$length": "$conversations"
										},
										0
									]
								}
							}
						},
						{
							"tool": "@core/computeMessageNames",
							"payload": {
								"conversations": "$conversations"
							},
							"onSuccess": {
								"updateContext": {
									"messageNames": "$$result"
								}
							}
						}
					]
				},
				"SEND_MESSAGE": {
					"target": "chatting"
				},
				"UPDATE_INPUT": {
					"target": "idle",
					"actions": [
						{
							"updateContext": {
								"inputText": "$$value"
							}
						}
					]
				}
			}
		},
		"chatting": {
			"entry": [
				{
					"updateContext": {
						"isLoading": true,
						"hasError": false
					}
				},
				{
					"tool": "@db",
					"payload": {
						"op": "create",
						"schema": "@maia/schema/data/chat",
						"data": {
							"role": "user",
							"content": "$$inputText"
						}
					}
				}
			],
			"on": {
				"SUCCESS": {
					"target": "calling_llm",
					"actions": [
						{
							"updateContext": {
								"inputText": ""
							}
						}
					]
				},
				"ERROR": {
					"target": "error",
					"actions": [
						{
							"updateContext": {
								"isLoading": false
							}
						}
					]
				}
			}
		},
		"calling_llm": {
			"entry": {
				"tool": "@ai/chat",
				"payload": {
					"model": "qwen/qwen3-30b-a3b-instruct-2507",
					"temperature": 1,
					"context": {
						"$concat": [
							[
								{
									"role": "system",
									"content": "You are Maia, a CTO-level AI assistant that understands the entire MaiaOS codebase, architecture, and all packages. You learn alongside coding sessions. Be helpful, technical, and concise. Never use emoticons in your responses."
								}
							],
							{
								"$map": {
									"array": "$conversations",
									"as": "msg",
									"return": {
										"role": "$$msg.role",
										"content": "$$msg.content"
									}
								}
							}
						]
					}
				}
			},
			"on": {
				"SUCCESS": {
					"target": "saving_response"
				},
				"ERROR": {
					"target": "error",
					"actions": [
						{
							"updateContext": {
								"isLoading": false
							}
						}
					]
				}
			}
		},
		"saving_response": {
			"entry": [
				{
					"tool": "@db",
					"payload": {
						"op": "create",
						"schema": "@maia/schema/data/chat",
						"data": {
							"role": "assistant",
							"content": "$$result.content"
						}
					}
				}
			],
			"on": {
				"SUCCESS": {
					"target": "idle",
					"actions": [
						{
							"updateContext": {
								"assistantResponse": null,
								"isLoading": false,
								"hasError": false
							}
						},
						{
							"updateContext": {
								"hasConversations": {
									"$gt": [
										{
											"$length": "$conversations"
										},
										0
									]
								}
							}
						},
						{
							"tool": "@core/computeMessageNames",
							"payload": {
								"conversations": "$conversations"
							},
							"onSuccess": {
								"updateContext": {
									"messageNames": "$$result"
								}
							}
						}
					]
				},
				"ERROR": {
					"target": "error",
					"actions": [
						{
							"updateContext": {
								"isLoading": false
							}
						}
					]
				}
			}
		},
		"error": {
			"entry": {
				"updateContext": {
					"error": "$$errors.0.message",
					"isLoading": false,
					"hasError": true
				}
			},
			"on": {
				"SEND_MESSAGE": {
					"target": "chatting",
					"actions": [
						{
							"updateContext": {
								"error": null,
								"hasError": false
							}
						}
					]
				},
				"RETRY": {
					"target": "idle",
					"actions": [
						{
							"updateContext": {
								"error": null,
								"hasError": false
							}
						}
					]
				},
				"DISMISS": {
					"target": "idle",
					"actions": [
						{
							"updateContext": {
								"error": null,
								"hasError": false
							}
						}
					]
				}
			}
		}
	}
}
