{
	"$schema": "°Maia/schema/state",
	"$id": "°Maia/chat/state/messages",
	"initial": "idle",
	"states": {
		"idle": {
			"entry": {
				"updateContext": {
					"hasConversations": {
						"$gt": [
							{
								"$length": "$conversations"
							},
							0
						]
					}
				}
			},
			"on": {
				"SEND_MESSAGE": {
					"target": "chatting"
				}
			}
		},
		"chatting": {
			"entry": [
				{
					"updateContext": {
						"isLoading": true,
						"hasError": false,
						"error": null,
						"pendingInputText": "$$inputText"
					}
				},
				{
					"sendEvent": {
						"target": "°Maia/chat/actor/intent",
						"type": "STATUS_UPDATE",
						"payload": {
							"isLoading": true,
							"hasError": false,
							"error": null
						}
					}
				},
				{
					"sendToActor": "°Maia/actor/db",
					"payload": {
						"op": "create",
						"schema": "°Maia/schema/data/chat",
						"data": {
							"role": "user",
							"content": "$$inputText",
							"displayName": "me"
						}
					}
				}
			],
			"on": {
				"SUCCESS": {
					"target": "calling_llm"
				},
				"ERROR": {
					"target": "error",
					"actions": [
						{
							"updateContext": {
								"isLoading": false
							}
						},
						{
							"sendEvent": {
								"target": "°Maia/chat/actor/intent",
								"type": "STATUS_UPDATE",
								"payload": {
									"isLoading": false,
									"hasError": true,
									"error": "$$errors.0.message"
								}
							}
						}
					]
				}
			}
		},
		"calling_llm": {
			"entry": {
				"sendToActor": "°Maia/actor/aiChat",
				"payload": {
					"model": "qwen/qwen3-30b-a3b-instruct-2507",
					"temperature": 1,
					"context": {
						"$concat": [
							[
								{
									"role": "system",
									"content": "You are Maia. Be helpful, technical, and concise. Never use emoticons in your responses. When you write to the paper via updatePaperContent and it succeeds, respond with only a short 1-2 sentence confirmation (e.g. \"I've written that to the paper.\" or \"Done. It's on the paper now.\"). Do NOT repeat or paste the full content in the chat—it is already visible on the paper."
								}
							],
							{
								"$map": {
									"array": "$conversations",
									"as": "msg",
									"return": {
										"role": "$$msg.role",
										"content": "$$msg.content"
									}
								}
							},
							[
								{
									"role": "user",
									"content": "$pendingInputText"
								}
							]
						]
					}
				}
			},
			"on": {
				"SUCCESS": {
					"target": "saving_response"
				},
				"ERROR": {
					"target": "error",
					"actions": [
						{
							"updateContext": {
								"isLoading": false
							}
						},
						{
							"sendEvent": {
								"target": "°Maia/chat/actor/intent",
								"type": "STATUS_UPDATE",
								"payload": {
									"isLoading": false,
									"hasError": true,
									"error": "$$errors.0.message"
								}
							}
						}
					]
				}
			}
		},
		"saving_response": {
			"entry": [
				{
					"sendToActor": "°Maia/actor/db",
					"payload": {
						"op": "create",
						"schema": "°Maia/schema/data/chat",
						"data": {
							"role": "assistant",
							"content": "$$result.content",
							"displayName": "Maia"
						}
					}
				}
			],
			"on": {
				"SUCCESS": {
					"target": "idle",
					"actions": [
						{
							"updateContext": {
								"isLoading": false,
								"hasError": false,
								"error": null,
								"hasConversations": true
							}
						},
						{
							"sendEvent": {
								"target": "°Maia/chat/actor/intent",
								"type": "STATUS_UPDATE",
								"payload": {
									"isLoading": false,
									"hasError": false,
									"error": null
								}
							}
						}
					]
				},
				"ERROR": {
					"target": "error",
					"actions": [
						{
							"updateContext": {
								"isLoading": false
							}
						},
						{
							"sendEvent": {
								"target": "°Maia/chat/actor/intent",
								"type": "STATUS_UPDATE",
								"payload": {
									"isLoading": false,
									"hasError": true,
									"error": "$$errors.0.message"
								}
							}
						}
					]
				}
			}
		},
		"error": {
			"entry": [
				{
					"updateContext": {
						"error": "$$errors.0.message",
						"isLoading": false,
						"hasError": true
					}
				},
				{
					"sendEvent": {
						"target": "°Maia/chat/actor/intent",
						"type": "STATUS_UPDATE",
						"payload": {
							"isLoading": false,
							"hasError": true,
							"error": "$$errors.0.message"
						}
					}
				}
			],
			"on": {
				"SEND_MESSAGE": {
					"target": "chatting",
					"actions": [
						{
							"updateContext": {
								"error": null,
								"hasError": false
							}
						}
					]
				},
				"RETRY": {
					"target": "idle",
					"actions": [
						{
							"updateContext": {
								"error": null,
								"hasError": false
							}
						}
					]
				},
				"DISMISS": {
					"target": "idle",
					"actions": [
						{
							"updateContext": {
								"error": null,
								"hasError": false
							}
						}
					]
				}
			}
		}
	}
}
