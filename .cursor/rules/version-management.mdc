---
alwaysApply: true
---

## Version Management

**Continuous version tagging.** Version is set automatically when a PR is merged to `next`. All packages share the same version.

### Format: `YY.MMDD.HHMM`

| Part | Example | Meaning |
|------|---------|---------|
| YY | 26 | Year |
| MMDD | 0212 | Feb 12 |
| HHMM | 2230 | 22:30 UTC |

Example: `26.0212.2230` = Feb 12, 2026 at 22:30 UTC.

### Scope

Every package gets the same version:
- All `services/*/package.json`
- All `libs/*/package.json`

No exclusions. Single source: the workflow generates the version and passes it to `sync-version.js`.

---

## Flow

```mermaid
flowchart LR
    PR[PR merged to next]
    VT[version-tag.yml]
    Sync[Sync all packages]
    Tag[Tag + Release]
    Deploy[deploy-next.yml]
    PR --> VT --> Sync --> Tag
    PR --> Deploy
```

1. PR passes checks and is merged to `next`.
2. Push to `next` triggers `version-tag` and `deploy-next`.
3. `version-tag`: Generate `YY.MMDD.HHMM`, sync to all packages, commit, tag, create GitHub release.
4. `deploy-next`: Deploy maia and moai.

Version changes only on merge to `next`. No manual bumping.

The workflow skips when the head commit message contains `chore: bump version to`, so the version-bump push does not trigger another run (no loop).

---

## Branch Strategy

- **`next`** – Deployment branch. Protected, updated only via PRs.
- Feature branches – Branch from `next`, merge back via PR.

---

## GitHub Actions

### Version Tag (`.github/workflows/version-tag.yml`)

- **Trigger:** Push to `next`.
- **Skips:** If the push is its own version-bump commit (avoids loop).
- **Steps:** Generate version → `bun run version:sync <version>` → commit → tag → release.

### Deploy Next (`.github/workflows/deploy-next.yml`)

- **Trigger:** Push to `next`.
- Deploys maia and moai to Fly.io (parallel).

---

## Local Sync (CI / scripting only)

Version is always supplied as an argument. No fallbacks.

```bash
bun run version:sync 26.0212.2230
```
