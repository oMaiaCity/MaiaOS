---
alwaysApply: true
---

# Hominio Monorepo Architecture

This repository is organized as a **Bun monorepo** using workspaces for better code organization and shared library management.

## Repository Structure

```
hominio/ (root)
├── package.json          # Root workspace configuration + root-level scripts
├── bun.lockb             # Bun lockfile (shared across workspaces)
├── .env                  # Root-level environment variables (all services/libs)
├── .github/
│   └── workflows/        # GitHub Actions workflows
├── .cursor/
│   └── rules/            # Cursor IDE rules
├── services/             # Application services
│   ├── app/              # Main application workspace
│   │   ├── package.json  # App-specific dependencies
│   │   ├── src/          # SvelteKit source code
│   │   ├── src-tauri/    # Tauri backend (Rust)
│   │   └── ...           # App-specific config files
│   ├── website/          # Landing page service
│   │   ├── package.json  # Service-specific dependencies
│   │   ├── index.html    # Landing page
│   │   └── vite.config.js
│   └── wallet/           # Auth service (BetterAuth API)
│       ├── package.json  # Service-specific dependencies
│       ├── src/          # SvelteKit API routes
│       └── vite.config.js
└── libs/                 # Shared libraries directory
    └── [package-name]/   # Individual shared packages
        ├── package.json
        └── src/
```

## Workspace Organization

### `services/app/` - Main Application
The primary application workspace containing:
- **Frontend**: SvelteKit application with Tailwind CSS
- **Backend**: Tauri (Rust) for desktop and iOS builds
- **Dependencies**: All app-specific dependencies declared here
- **Scripts**: Build, dev, and release scripts
- **Version Management**: Uses semantic-release for automated versioning

### `libs/` - Shared Libraries
Reusable packages that can be shared across multiple workspaces:
- Each subdirectory in `libs/` is a separate workspace
- Libraries are self-contained with their own `package.json`
- Can be imported using `workspace:*` syntax in other workspaces
- Examples: shared utilities, types, components, etc.

## Dependency Management

### Root Package.json
- **NO dependencies or devDependencies** at root level
- Contains workspace configuration: `"workspaces": ["services/*", "libs/*"]`
- **Root-level scripts**: Delegates to workspaces using `bun --filter`
- All common commands can be run from root (dev, build, release, etc.)
- Keeps the monorepo structure clean and maintainable

### Workspace Dependencies

**Inter-Package Dependencies:**
Each workspace can depend on other workspaces (services or libs) using the `workspace:*` protocol. This is a core feature of monorepos that enables code sharing and proper dependency management.

**Dependency Types:**
- **External packages**: Use normal version specifiers (`"^1.0.0"`)
- **Internal packages**: Use `workspace:*` syntax to reference other workspaces

**Supported Dependency Patterns:**

1. **Service depends on Library:**
```json
// services/app/package.json
{
  "dependencies": {
    "@hominio/shared-utils": "workspace:*",
    "@hominio/ui-components": "workspace:*"
  }
}
```

2. **Service depends on another Service:**
```json
// services/api/package.json
{
  "dependencies": {
    "@hominio/shared-utils": "workspace:*",
    "app": "workspace:*"  // Can depend on other services
  }
}
```

3. **Library depends on another Library:**
```json
// libs/ui-components/package.json
{
  "dependencies": {
    "@hominio/shared-utils": "workspace:*"  // Libs can depend on other libs
  }
}
```

**Usage in Code:**
```javascript
// In services/app/src/some-file.js
import { someUtil } from "@hominio/shared-utils";
import { Button } from "@hominio/ui-components";
import { apiClient } from "app"; // If app depends on another service
```

**Important Notes:**
- Bun automatically resolves `workspace:*` dependencies to the local workspace
- Dependencies are hoisted when possible for efficiency
- Circular dependencies should be avoided (Bun will warn you)
- Always run `bun install` from root after adding dependencies

## Adding a New Shared Library

1. **Create the library directory:**
   ```bash
   mkdir -p libs/my-shared-lib
   cd libs/my-shared-lib
   ```

2. **Create package.json:**
   ```json
   {
     "name": "@hominio/my-shared-lib",
     "version": "0.1.23",
     "type": "module",
     "main": "src/index.js",
     "exports": {
       ".": "./src/index.js"
     },
     "dependencies": {
       // Can depend on other libs or external packages
       "@hominio/another-lib": "workspace:*"
     }
   }
   ```
   **Note:** Version should match the monorepo version (managed centrally)

3. **Create source files:**
   ```bash
   mkdir src
   # Add your library code in src/index.js
   ```

4. **Install dependencies:**
   ```bash
   bun install  # From root - installs for all workspaces
   ```

5. **Use in services or other libs:**
   Add to workspace's `package.json`:
   ```json
   {
     "dependencies": {
       "@hominio/my-shared-lib": "workspace:*"
     }
   }
   ```
   Then run `bun install` from root.

6. **Import and use:**
   ```javascript
   // In any service or lib
   import { someFunction } from "@hominio/my-shared-lib";
   ```

## Development Workflow

### Running Commands

**From root (recommended - single command for everything):**
```bash
bun install                    # Install dependencies for all workspaces
bun dev                        # Run both maia-city (4200) and api (4201) dev servers in parallel
bun dev:city                   # Run only maia-city service dev server (port 4200)
bun dev:api                    # Run only API service dev server (port 4201)
bun dev:app                    # Run only app dev server (port 4202)
bun build                      # Build app (delegates to services/app)
bun build:city                 # Build maia-city service (delegates to services/maia-city)
bun build:api                  # Build API service (delegates to services/api)
bun release                    # Run semantic-release (delegates to services/app)
bun tauri:dev                  # Run Tauri dev (delegates to services/app)
```

**Note:** `bun dev` runs both website and app services in parallel using shell `&` operator. Both services start simultaneously and output is interleaved. Use `bun dev:website`, `bun dev:wallet`, or `bun dev:app` to run a single service for cleaner output.

**From specific workspace (alternative):**
```bash
cd services/app
bun run dev                    # Run app dev server
bun run tauri:dev              # Run Tauri dev
bun run build                  # Build app

cd services/website
bun run dev                    # Run website service dev server
bun run build                  # Build website service

cd services/api
bun run dev                    # Run API service dev server
bun run build                  # Build API service
```

### Building

Each workspace builds independently:
```bash
# From root (recommended)
bun build                      # Build app

# Or from workspace
cd services/app && bun run build        # Build app
cd libs/my-lib && bun run build         # Build shared library (if it has build script)
```

## Version Management

- **Centralized versioning**: All services and libraries share the **same version number** across the entire monorepo
- **Single source of truth**: Version is managed in `services/app/package.json` via semantic-release
- **Automatic sync**: When a release is created, versions are automatically synced to:
  - All `services/*/package.json` files
  - All `libs/*/package.json` files
  - `services/app/src-tauri/Cargo.toml` (Rust)
  - `services/app/src-tauri/tauri.conf.json` (Tauri)
  - `services/app/src-tauri/gen/apple/app_iOS/Info.plist` (iOS)
  - `services/app/src-tauri/gen/apple/project.yml` (iOS)
- **Release workflow**: Configured for `services/app/` workspace, but affects all packages
- **Root-level commands**: 
  - `bun version:sync <version>` - Manually sync version across all packages
  - `bun release` - Run semantic-release (analyzes commits, bumps version, creates release)
  - `bun release:dry-run` - Test what semantic-release would do
  - `bun release:major` - Manually trigger major version bump

## Git Workflow

- **Single repository**: All workspaces live in one git repository
- **Shared history**: Changes across workspaces share git history
- **Branching**: Use feature branches for changes across workspaces
- **Commits**: Can commit changes to multiple workspaces in one commit

## Best Practices

1. **Keep root minimal**: Only workspace configuration at root
2. **Self-contained workspaces**: Each workspace should be independently buildable
3. **Shared code in libs/**: Don't duplicate code - extract to shared libraries
4. **Clear naming**: Use `@hominio/` prefix for internal packages
5. **Dependency management**: 
   - Use `workspace:*` for internal dependencies
   - Avoid circular dependencies (Bun will warn)
   - Keep dependencies minimal - only add what's needed
6. **Version sync**: All packages share the same version (managed centrally)
7. **Documentation**: Each workspace/library should have its own README if complex
8. **Build order**: If services depend on each other, build dependencies first

## Port Management

**Hardcoded Port Assignments:**
Each service in the monorepo has a **hardcoded development port** to avoid conflicts and ensure consistency across team members. Ports are assigned sequentially from a safe range.

**Port Range: 4200-4210**
- Reserved for Hominio services (up to 11 services)
- Avoids conflicts with common framework defaults:
  - `3000-3010`: Next.js, Express, Create React App
  - `5173`: Vite (used by `app` service)
  - `8080-8090`: Common web servers
  - `8000-8010`: Django, some Node apps
  - `5000-5010`: Flask, some Node apps

**Current Port Assignments:**
| Service | Port | Notes |
|---------|------|-------|
| `services/maia-city` | `4200` | Landing page (default `bun dev`) |
| `services/api` | `4201` | API proxy service (Honcho, RedPill, Voice) |
| `services/app` | `4202` | Main application (Tauri-compatible) |
| `services/[next-service]` | `4203` | Next service port (e.g., sync) |
| `services/[service-4]` | `4204` | Reserved |
| ... | ... | ... |
| `services/[service-10]` | `4210` | Reserved |

**Configuration:**
- Ports are configured in each service's `vite.config.js` or server configuration
- Can be overridden via environment variables for flexibility
- Document port assignments in this file when adding new services

**Example Vite Config:**
```javascript
// services/app/vite.config.js
export default defineConfig({
  server: {
    port: process.env.PORT || 4201, // Hardcoded default
    strictPort: true,
  },
});
```

## Environment Variables

**Centralized Management:**
- All environment variables are managed at the **root level** (`.env` file)
- Root `.env` contains all variables needed by services and libs
- Each service/lib only receives the env vars it needs (delegated via scripts/config)
- This ensures consistency and makes it easier to manage secrets

**Structure:**
```
hominio/
├── .env                    # Root-level env vars (all services/libs)
├── services/
│   └── app/
│       └── .env.local      # Optional: service-specific overrides (gitignored)
└── libs/
    └── [lib]/
        └── .env.local      # Optional: lib-specific overrides (gitignored)
```

**Best Practices:**
- Keep all production secrets in root `.env` (or CI/CD secrets)
- Use `.env.local` for local development overrides (gitignored)
- Document required env vars in each service/lib README
- Use `process.env` or `$env` (SvelteKit) to access variables
- Create `.env.example` at root documenting all required variables (without sensitive values)

**Example Root .env Structure:**
```bash
# Root .env file (all services/libs)
NODE_ENV=development

# Service-specific ports (hardcoded in config, documented here)
# PUBLIC_DOMAIN_ME=localhost:4200 (maia-city service)
# PUBLIC_DOMAIN_API=localhost:4201 (api service - Honcho, RedPill, Voice)
# PUBLIC_DOMAIN_APP=localhost:4202 (app service)
# PUBLIC_DOMAIN_SYNC=localhost:4203 (sync service, future)

# Library-specific vars (delegated to libs/*)
# LIBS_SHARED_UTILS_API_KEY=your-key
```

## Common Commands

```bash
# Install all dependencies (from root)
bun install

# Run development server (from root)
bun dev

# Build (from root)
bun build

# Run semantic-release (from root)
bun release

# Add dependency to app workspace
cd services/app && bun add <package>

# Add dependency to shared library
cd libs/my-lib && bun add <package>

# Run script in specific workspace using filter
bun --filter app dev

# Run script in all workspaces
bun --filter '*' build
```

## Notes

- Bun automatically hoists dependencies when possible
- Workspaces can depend on each other using `workspace:*`
- TypeScript/JavaScript can import from workspace packages directly
- Build outputs remain in their respective workspace directories
