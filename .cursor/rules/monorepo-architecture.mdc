---
alwaysApply: true
---

# MaiaOS Monorepo Architecture

This repository is organized as a **Bun monorepo** using workspaces for better code organization and shared library management.

## Repository Structure

```
MaiaOS/ (root)
├── package.json          # Root workspace configuration + root-level scripts
├── bun.lockb             # Bun lockfile (shared across workspaces)
├── .env                  # Root-level environment variables (all services/libs)
├── .github/
│   └── workflows/        # GitHub Actions workflows
├── .cursor/
│   └── rules/            # Cursor IDE rules
├── services/             # Application services
│   ├── maia/             # Frontend SPA (next.maia.city)
│   │   ├── package.json
│   │   ├── main.js       # Bun-built SPA entry
│   │   └── server.js     # Static file server (Bun)
│   └── moai/             # Sync + API service (moai.next.maia.city)
│       ├── package.json
│       └── deploy.sh     # Runs moai-server.mjs from maia-distros output
└── libs/                 # Shared libraries (@MaiaOS/*)
    └── maia-*/           # maia-db, maia-loader, maia-actors, etc.
        ├── package.json
        └── src/
```

## Workspace Organization

### `services/maia/` - Frontend SPA
- **Port 4200** (dev)
- Bun-built SPA, pure static server (no proxy)
- Client connects directly to moai (4201) for sync/API — CORS enabled on moai
- Sync domain: `VITE_PEER_MOAI` at build time (fly.toml [build.args])

### `services/moai/` - Sync + API
- **Port 4201** (dev)
- Unified: WebSocket sync (cojson LocalNode), agent API, LLM proxy
- Secrets: `PEER_ID`, `PEER_SECRET`, `RED_PILL_API_KEY`, etc. (no PEER_MOAI for maia deploy)

### `libs/` - Shared Libraries
Reusable packages that can be shared across multiple workspaces:
- Each subdirectory in `libs/` is a separate workspace
- Libraries are self-contained with their own `package.json`
- Can be imported using `workspace:*` syntax in other workspaces
- Examples: shared utilities, types, components, etc.

## Dependency Management

### Root Package.json
- **NO dependencies or devDependencies** at root level
- Contains workspace configuration: `"workspaces": ["services/maia", "services/moai", "libs/*"]`
- **Root-level scripts**: Delegates to workspaces using `bun --filter`
- All common commands can be run from root (dev, build, release, etc.)
- Keeps the monorepo structure clean and maintainable

### Workspace Dependencies

**Inter-Package Dependencies:**
Each workspace can depend on other workspaces (services or libs) using the `workspace:*` protocol. This is a core feature of monorepos that enables code sharing and proper dependency management.

**Dependency Types:**
- **External packages**: Use normal version specifiers (`"^1.0.0"`)
- **Internal packages**: Use `workspace:*` syntax to reference other workspaces

**Supported Dependency Patterns:**

1. **Single-entry pattern: services import only from loader**
```json
// services/maia/package.json - only maia-distros (loader/vibes via jsconfig)
// services/moai/package.json - maia-distros + @MaiaOS/loader
```
Services depend only on `@MaiaOS/loader`. Loader re-exports everything needed: db, schemata, actors, vibes (via dynamic import), cojson-transport-ws. maia-distros has no app logic—only bundling. Services own logic; distros produces bundles (maia-client, vibes, moai-server). Prod runs bundles.

2. **Library depends on another Library:**
```json
// libs/maia-loader/package.json
{
  "dependencies": {
    "@MaiaOS/db": "workspace:*",
    "@MaiaOS/actors": "workspace:*"
  }
}
```

**Usage in Code:**
```javascript
import { setupSyncPeers } from "@MaiaOS/db";
import { getApiBaseUrl } from "@MaiaOS/actors";
```

**Important Notes:**
- Bun automatically resolves `workspace:*` dependencies to the local workspace
- Dependencies are hoisted when possible for efficiency
- Circular dependencies should be avoided (Bun will warn you)
- Always run `bun install` from root after adding dependencies

## Adding a New Shared Library

1. **Create the library directory:**
   ```bash
   mkdir -p libs/my-shared-lib
   cd libs/my-shared-lib
   ```

2. **Create package.json:**
   ```json
   {
     "name": "@MaiaOS/my-lib",
     "version": "0.1.23",
     "type": "module",
     "main": "src/index.js",
     "exports": {
       ".": "./src/index.js"
     },
     "dependencies": {
       "@MaiaOS/db": "workspace:*"
     }
   }
   ```
   **Note:** Version should match the monorepo version (managed centrally)

3. **Create source files:**
   ```bash
   mkdir src
   # Add your library code in src/index.js
   ```

4. **Install dependencies:**
   ```bash
   bun install  # From root - installs for all workspaces
   ```

5. **Use in services or other libs:**
   Add to workspace's `package.json`:
   ```json
   {
     "dependencies": {
       "@MaiaOS/my-lib": "workspace:*"
     }
   }
   ```
   Then run `bun install` from root.

## Development Workflow

### Running Commands

**From root (recommended - single command for everything):**
```bash
bun install                    # Install dependencies for all workspaces
bun dev                        # Run maia (4200) and moai (4201) in parallel
bun dev:maia                   # Run only maia dev server (port 4200)
bun dev:moai                   # Run only moai dev server (port 4201)
bun run version:sync <version>  # Sync version (CI does this on merge to next)
bun deploy                     # Deploy maia + moai to Fly.io
```

**Note:** `bun dev` runs maia (4200) and moai (4201) in parallel. Use `bun dev:maia` or `bun dev:moai` for a single service.

**From specific workspace (alternative):**
```bash
cd services/maia
bun run dev                    # Run maia dev server (4200)
bun run build                  # Build maia (Bun)

cd services/moai
bun run dev                    # Run moai dev server (4201)
bun run build                  # Build moai
```

### Building

Each workspace builds independently:
```bash
cd services/maia && bun run build       # Build maia (Bun, uses distros bundles)
cd services/moai && bun run build      # Build moai
cd libs/maia-distros && bun run build   # Build bundles (client, server, vibes)
```

## Version Management

- **Continuous version tagging**: Version is set automatically when a PR is merged to `next` (format: `YY.MMDD.HHMM`)
- **Centralized**: All services and libraries share the same version
- **Root-level command**: `bun run version:sync <version>` — for CI/scripting; version required, no fallbacks

## Git Workflow

- **Single repository**: All workspaces live in one git repository
- **Shared history**: Changes across workspaces share git history
- **Branching**: Use feature branches for changes across workspaces
- **Commits**: Can commit changes to multiple workspaces in one commit

## Best Practices

1. **Keep root minimal**: Only workspace configuration at root
2. **Self-contained workspaces**: Each workspace should be independently buildable
3. **Shared code in libs/**: Don't duplicate code - extract to shared libraries
4. **Clear naming**: Use `@MaiaOS/` prefix for internal packages
5. **Dependency management**: 
   - Use `workspace:*` for internal dependencies
   - Avoid circular dependencies (Bun will warn)
   - Keep dependencies minimal - only add what's needed
6. **Version sync**: All packages share the same version (managed centrally)
7. **Documentation**: Each workspace/library should have its own README if complex
8. **Build order**: If services depend on each other, build dependencies first

## Port Management

**Hardcoded Port Assignments:**
Each service in the monorepo has a **hardcoded development port** to avoid conflicts and ensure consistency across team members. Ports are assigned sequentially from a safe range.

**Port Range: 4200-4210**
- Reserved for MaiaOS services
- Avoids conflicts with common framework defaults:
  - `3000-3010`: Next.js, Express, Create React App
  - `5173`: Vite default
  - `8080-8090`: Common web servers
  - `8000-8010`: Django, some Node apps
  - `5000-5010`: Flask, some Node apps

**Current Port Assignments:**
| Service | Port | Notes |
|---------|------|-------|
| `services/maia` | `4200` | Frontend SPA (default `bun dev`) |
| `services/moai` | `4201` | Unified sync (WebSocket + agent API + LLM proxy) |
| `4202-4210` | Reserved | |

**Configuration:**
- Ports are configured in each service's dev script or server configuration
- Can be overridden via environment variables for flexibility
- Document port assignments in this file when adding new services

## Environment Variables

**Centralized Management:**
- All environment variables are managed at the **root level** (`.env` file)
- Root `.env` contains all variables needed by services and libs
- Each service/lib only receives the env vars it needs (delegated via scripts/config)
- This ensures consistency and makes it easier to manage secrets

**Structure:**
```
MaiaOS/
├── .env                    # Root-level env vars (all services/libs)
├── services/
│   └── maia/
│       └── .env.local      # Optional: service-specific overrides (gitignored)
└── libs/
    └── [lib]/
        └── .env.local      # Optional: lib-specific overrides (gitignored)
```

**Vite vs Non-Vite Env Vars:**
- **VITE_*** prefix: Exposed to client via `import.meta.env.VITE_*`. Inlined at build time into the bundle. Use for public client-side config (sync domains, API URLs).
- **Non-VITE_** prefix: Only in Node at build/serve. Not exposed to client (security). Use for secrets, DB URLs, server-only config.
- **Build-time preferred** for per-environment public config: Pass via Dockerfile ARG + fly.toml [build.args]. No runtime injection or globals needed.
- **Runtime only when required**: e.g. feature flags that change without rebuild. For stable per-deploy config, build-time is cleaner.

**Best Practices:**
- Keep all production secrets in root `.env` (or CI/CD secrets)
- Use `.env.local` for local development overrides (gitignored)
- Document required env vars in each service/lib README
- Use `process.env` or `$env` (SvelteKit) to access variables
- Create `.env.example` at root documenting all required variables (without sensitive values)

**Peer / Sync Domain:**
- **Maia (frontend)**: `VITE_PEER_MOAI` at build time only (fly.toml [build.args]). No PEER_MOAI Fly secret.
- **Moai (agent mode)**: `PEER_MOAI` when PEER_MODE=agent (future). Not used for normal sync deployment.
- **PEER_MAIA**: Not used in code at present. Leave unset.

## Common Commands

```bash
# Install all dependencies (from root)
bun install

# Run development server (from root)
bun dev

# Build maia (from services/maia)
cd services/maia && bun run build


# Add dependency to maia
cd services/maia && bun add <package>

# Add dependency to shared library
cd libs/maia-db && bun add <package>

# Run script in specific workspace
bun --filter maia dev
```

## Notes

- Bun automatically hoists dependencies when possible
- Workspaces can depend on each other using `workspace:*`
- TypeScript/JavaScript can import from workspace packages directly
- Build outputs remain in their respective workspace directories
