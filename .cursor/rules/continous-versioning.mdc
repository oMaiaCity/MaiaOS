---
alwaysApply: true
---

## Version Management

**Continuous version tagging.** Version is set automatically when a PR is merged to `next`. All packages share the same version.

### Format: `YY.MMDD.HHMM`

| Part | Example | Meaning |
|------|---------|---------|
| YY | 26 | Year |
| MMDD | 0212 | Feb 12 |
| HHMM | 2230 | 22:30 UTC |

Example: `26.0212.2230` = Feb 12, 2026 at 22:30 UTC.

### Scope

Every package gets the same version:
- All `services/*/package.json`
- All `libs/*/package.json`

No exclusions. Single source: the workflow generates the version and passes it to `sync-version.js`.

---

## Flow

```mermaid
flowchart LR
    Branch[Branch from next]
    Commit[Commit changes]
    Push[Push branch]
    AskPR{Ask user: create PR?}
    CreatePR[gh pr create]
    Merge[gh pr merge]
    VT[version-tag.yml]
    Sync[Sync packages]
    Tag[Tag + Release]
    Deploy[deploy-next.yml]

    Branch --> Commit --> Push --> AskPR
    AskPR -->|Yes| CreatePR --> Merge
    Merge --> VT --> Sync --> Tag
    Merge --> Deploy
```

**Developer flow:**
1. Branch from `next`, make changes, commit, push.
2. **Ask the user** if they want to create a PR. Only create when confirmed.
3. `gh pr create` → open PR targeting `next`.
4. CI runs (Lint & Format + Build). **Both must pass** before merge.
5. **Ask the user** if they want to merge. Only merge when confirmed.
6. `gh pr merge --rebase` → merge into `next`.

**CI flow (after merge):**
1. Push to `next` triggers `version-tag` and `deploy-next`.
2. `version-tag`: Generate `YY.MMDD.HHMM`, sync all packages, commit, tag, create GitHub release.
3. `deploy-next`: Deploy maia and moai.

Version changes only on merge to `next`. No manual bumping.

The version-tag workflow skips when the head commit message starts with `[release] `, so the release push does not trigger another run (no loop). Deploy-next runs only on `[release]` commits (or manual trigger), so we deploy once per merge.

---

## Commit Messages

Standard prefix format (brackets). None trigger workflows except `[release]`:

| Prefix | Use for |
|--------|---------|
| `[release]` | Version bump (CI only; do not use manually) |
| `[fix]` | Bug fixes, improvements |
| `[feat]` | New features |
| `[chore]` | Maintenance, deps, config |
| `[docs]` | Documentation |

Example: `[fix] resolve login button styling`

---

## Branch Strategy

- **`next`** – Deployment branch. Protected, updated only via PRs.
- Feature branches – Branch from `next`, merge back via PR.

---

## PR Workflow (gh CLI)

**Always ask the user** before creating or merging a PR. Never create or merge PRs without explicit confirmation.

```bash
# Create PR (after pushing branch)
gh pr create --base next --head <branch> --title "<title>" --body "<body>"

# Merge (rebase and merge)
gh pr merge <number> --rebase
```

---

## GitHub Actions

### Version Tag (`.github/workflows/version-tag.yml`)

- **Trigger:** Push to `next`.
- **Skips:** If the push is its own release commit (avoids loop).
- **Steps:** Generate version → `bun run version:sync <version>` → commit → tag → release.
- **Requires:** `DEPLOY_KEY` secret (SSH private key) to push to protected `next`.

**Protected branch setup:** GitHub Actions is not a bypass actor. Add **Deploy keys** to the bypass list for the ruleset that applies to `next`. Ensure Deploy keys bypasses **all** rules (including "Require pull request"), then:
1. Generate SSH key: `ssh-keygen -t ed25519 -f ~/.ssh/maia_version_tag_deploy -N ""`
2. Add **public** key to repo Settings → Deploy keys (allow write access).
3. Add **private** key as repo secret `DEPLOY_KEY` (full content including BEGIN/END lines).
4. Only the workflow (using this key) can push; no user bypass needed.

### Deploy Next (`.github/workflows/deploy-next.yml`)

- **Trigger:** Push to `next`, or manual.
- **Runs only on:** `[release]` commits (version-tag push) or workflow_dispatch. Skips merge commits — deploy once per merge.
- Deploys maia and moai to Fly.io (parallel).

### CI (`.github/workflows/biome.yml`)

- **Trigger:** Pull requests and pushes to `next`.
- **Jobs:**
  1. **Lint & Format** – `bun run check:ci` (Biome + .maia format check).
  2. **Build (maia + moai)** – Docker build for both services. Validates deployment will succeed before merge.
- **Branch protection:** Require **both** jobs before PRs can merge into `next`. Settings → Branches → Rules for `next` → Require status checks → Add `Lint & Format` and `Build (maia + moai)`. If "No results" appears, push a PR, let the workflow run once, then the check names become searchable.
- **Deployment gate:** PRs cannot merge until the Build job passes. This prevents merging code that would break the deploy pipeline.
- **When changing:** Dockerfiles, `package.json` workspaces, or deploy scripts — ensure the Build job passes before merging.

---

## Pre-commit (Biome)

On each commit (local), Husky runs:
1. **lint-staged** – Auto-fix staged files with Biome.
2. **check:ci** – Verify full codebase passes. Commit blocked if it fails.

---

## Local Sync (CI / scripting only)

Version is always supplied as an argument. No fallbacks.

```bash
bun run version:sync 26.0212.2230
```
