---
alwaysApply: true
---

## Version Management

**Continuous version tagging.** Version is set automatically when a PR is merged to `next`. All packages share the same version.

### Format: `YY.MMDD.HHMM`

| Part | Example | Meaning |
|------|---------|---------|
| YY | 26 | Year |
| MMDD | 0212 | Feb 12 |
| HHMM | 2230 | 22:30 UTC |

Example: `26.0212.2230` = Feb 12, 2026 at 22:30 UTC.

### Scope

Every package gets the same version:
- All `services/*/package.json`
- All `libs/*/package.json`

No exclusions. Single source: the workflow generates the version and passes it to `sync-version.js`.

---

## Flow

```mermaid
flowchart LR
    Branch[Branch from next]
    Commit[Commit changes]
    Push[Push branch]
    AskPR{Ask user: create PR?}
    CreatePR[gh pr create]
    Merge[gh pr merge]
    VT[version-tag.yml]
    Sync[Sync packages]
    Tag[Tag + Release]
    Deploy[deploy-next.yml]

    Branch --> Commit --> Push --> AskPR
    AskPR -->|Yes| CreatePR --> Merge
    Merge --> VT --> Sync --> Tag
    Merge --> Deploy
```

**Developer flow:**
1. Branch from `next`, make changes, commit, push.
2. **Ask the user** if they want to create a PR. Only create when confirmed.
3. `gh pr create` → open PR targeting `next`.
4. **Ask the user** if they want to merge. Only merge when confirmed.
5. `gh pr merge --rebase` → merge into `next`.

**CI flow (after merge):**
1. Push to `next` triggers `version-tag` and `deploy-next`.
2. `version-tag`: Generate `YY.MMDD.HHMM`, sync all packages, commit, tag, create GitHub release.
3. `deploy-next`: Deploy maia and moai.

Version changes only on merge to `next`. No manual bumping.

The workflow skips when the head commit message contains `chore: bump version to`, so the version-bump push does not trigger another run (no loop).

---

## Branch Strategy

- **`next`** – Deployment branch. Protected, updated only via PRs.
- Feature branches – Branch from `next`, merge back via PR.

---

## PR Workflow (gh CLI)

**Always ask the user** before creating or merging a PR. Never create or merge PRs without explicit confirmation.

```bash
# Create PR (after pushing branch)
gh pr create --base next --head <branch> --title "<title>" --body "<body>"

# Merge (rebase and merge)
gh pr merge <number> --rebase
```

---

## GitHub Actions

### Version Tag (`.github/workflows/version-tag.yml`)

- **Trigger:** Push to `next`.
- **Skips:** If the push is its own version-bump commit (avoids loop).
- **Steps:** Generate version → `bun run version:sync <version>` → commit → tag → release.
- **Requires:** `REPO_PAT` secret (PAT from repo admin) to push to protected `next`.

**Protected branch setup:** GitHub Actions is not a bypass actor. Add **Repository admin** to the bypass list, then:
1. Create a PAT (classic `repo` or fine-grained Contents: Read and write) from a repo admin.
2. Add as repo secret `REPO_PAT`.
3. Workflow pushes as that user; admin bypass allows it.

### Deploy Next (`.github/workflows/deploy-next.yml`)

- **Trigger:** Push to `next`.
- Deploys maia and moai to Fly.io (parallel).

---

## Local Sync (CI / scripting only)

Version is always supplied as an argument. No fallbacks.

```bash
bun run version:sync 26.0212.2230
```
